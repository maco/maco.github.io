<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Pretty Waterfalls in Honeycomb for an Absinthe app - Mackenzie Morgan</title><meta name=Description content><meta property="og:url" content="https://mackenzie.morgan.name/posts/pretty-waterfalls-in-honeycomb/"><meta property="og:type" content="article"><meta property="og:site_name" content="Mackenzie Morgan"><meta property="og:title" content="Pretty Waterfalls in Honeycomb for an Absinthe app"><meta property="og:description" content="When first setting up the Absinthe app I work on, someone added OpenCensus Honeycomb package. The way it was set up was very basic: each top-level query had tracing attached.
:object queries do field :getStuff, :stuff do meta :trace, true arg :input, :string resolve &amp;amp;Resolver.stuff_resolver/3 en"><meta property="og:image" content="https://mackenzie.morgan.name/tcard/pretty-waterfalls-in-honeycomb.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@"><meta name=application-name content="Mackenzie Morgan"><meta name=apple-mobile-web-app-title content="Mackenzie Morgan"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mackenzie.morgan.name/posts/pretty-waterfalls-in-honeycomb/><link rel=prev href=https://mackenzie.morgan.name/posts/reusable-django-admin-filters/><link rel=next href=https://mackenzie.morgan.name/posts/advent-of-code-2021/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Pretty Waterfalls in Honeycomb for an Absinthe app","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mackenzie.morgan.name\/posts\/pretty-waterfalls-in-honeycomb\/"},"genre":"posts","keywords":"elixir, code, telemetry, absinthe","wordcount":410,"url":"https:\/\/mackenzie.morgan.name\/posts\/pretty-waterfalls-in-honeycomb\/","datePublished":"2021-10-27T10:14:01-04:00","dateModified":"2021-10-27T10:14:01-04:00","publisher":{"@type":"Organization","name":"Mackenzie Morgan"},"author":{"@type":"Person","name":"Mackenzie Morgan"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":""==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:""==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Mackenzie Morgan">Mackenzie Morgan</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/speaking/>Speaking </a><a class=menu-item href=/cv/>CV </a><a class=menu-item href=/now/>Now </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Mackenzie Morgan">Mackenzie Morgan</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/speaking/ title>Speaking</a><a class=menu-item href=/cv/ title>CV</a><a class=menu-item href=/now/ title>Now</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Pretty Waterfalls in Honeycomb for an Absinthe app</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Mackenzie Morgan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-10-27>2021-10-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;410 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;2 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><p>When first setting up the Absinthe app I work on, someone added <a href=https://github.com/opencensus-beam/opencensus_honeycomb target=_blank rel="noopener noreffer">OpenCensus Honeycomb package</a>. The way it was set up was very basic: each top-level query had tracing attached.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=ss>:object</span> <span class=n>queries</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:getStuff</span><span class=p>,</span> <span class=ss>:stuff</span> <span class=k>do</span>
</span></span><span class="line hl"><span class=cl>    <span class=n>meta</span> <span class=ss>:trace</span><span class=p>,</span> <span class=no>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>arg</span> <span class=ss>:input</span><span class=p>,</span> <span class=ss>:string</span>
</span></span><span class=line><span class=cl>    <span class=n>resolve</span> <span class=o>&amp;</span><span class=nc>Resolver</span><span class=o>.</span><span class=n>stuff_resolver</span><span class=o>/</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>This got us information on how long each query took, so we could see which query needed to be optimized and do some debugging when performance issues hit. But it didn&rsquo;t drill down like I wanted.</p><h1 id=making-it-better>Making it better</h1><p>The first time I tried to solve this, I looked at how telemetry works in the BEAM, and I didn&rsquo;t want to do a bunch of manual stuff at the start and end of every function. Then I found <a href=https://hexdocs.pm/telemetry_decorator/ target=_blank rel="noopener noreffer">Telemetry Decorator</a> and thought I had a handy little solution. Nope. Turns out, BEAM telemetry and OpenCensus are different systems that maybe don&rsquo;t talk to each other. Or at least, they don&rsquo;t do automagic.</p><p>More recently, I dug into it again. This time, I looked at the <a href=https://opencensus.io/quickstart/erlang/tracing/#instrumentation target=_blank rel="noopener noreffer">OpenCensus documentation on tracing</a> and found out about</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=n>with_child_span</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>...</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>(Sidebar: I love that they give both Erlang and Elixir examples!)</p><p>So, I tried adding that wrapper to a bunch of functions. I got traces for them! â€¦but they weren&rsquo;t attached to their queries. So then I tried adding <code>with_child_span</code> to resolver functions, and that was a <em>big</em> mistake. That doesn&rsquo;t compile; don&rsquo;t do that.</p><p>What was I missing?</p><p>Diving into the <a href=https://github.com/opencensus-beam/opencensus_absinthe#schema target=_blank rel="noopener noreffer">Absinthe-specific documentation</a>, I spotted this:</p><blockquote><p>Until Absinthe merge and publish their telemetry support (see below) and you upgrade, you&rsquo;ll also need to set :trace in the metadata for any field for which you want tracing to happen</p></blockquote><p>&ldquo;Any field.&rdquo; Not &ldquo;any query.&rdquo; Field. Let&rsquo;s try it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=n>object</span> <span class=ss>:stuff</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:id</span><span class=p>,</span> <span class=n>non_null</span><span class=p>(</span><span class=ss>:id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:thing</span><span class=p>,</span> <span class=ss>:string</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:percentage</span><span class=p>,</span> <span class=ss>:integer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ss>resolve</span><span class=p>:</span> <span class=o>&amp;</span><span class=nc>Resolver</span><span class=o>.</span><span class=n>stuff_percentage</span><span class=o>/</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>became</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elixir data-lang=elixir><span class=line><span class=cl><span class=n>object</span> <span class=ss>:stuff</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:id</span><span class=p>,</span> <span class=n>non_null</span><span class=p>(</span><span class=ss>:id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:thing</span><span class=p>,</span> <span class=ss>:string</span>
</span></span><span class=line><span class=cl>  <span class=n>field</span> <span class=ss>:percentage</span><span class=p>,</span> <span class=ss>:integer</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=ss>meta</span><span class=p>:</span> <span class=p>[</span><span class=ss>trace</span><span class=p>:</span> <span class=no>true</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=ss>resolve</span><span class=p>:</span> <span class=o>&amp;</span><span class=nc>Resolver</span><span class=o>.</span><span class=n>stuff_percentage</span><span class=o>/</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>And we got our pretty waterfall graphs showing up in Honeycomb. They still break anywhere you use <code>Async</code> functions. I suspect getting around that would involve a closure, grabbing the span from the parent function then passing it as an argument to the <code>Async</code>-wrapped function, which would then manually set up its context.</p><h1 id=tldr>TL;DR</h1><p>Three things to remember when using OpenCensus in an Absinthe app:</p><ol><li>add <code>meta: [trace: true]</code> to <em>anything</em> that has a resolver</li><li>wrap methods in <code>with_child_span</code></li><li>don&rsquo;t wrap the resolver functions</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-10-27</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/elixir/>elixir</a>,&nbsp;<a href=/tags/code/>code</a>,&nbsp;<a href=/tags/telemetry/>telemetry</a>,&nbsp;<a href=/tags/absinthe/>absinthe</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/reusable-django-admin-filters/ class=prev rel=prev title="Reusable Django Admin Filters"><i class="fas fa-angle-left fa-fw"></i>Reusable Django Admin Filters</a>
<a href=/posts/advent-of-code-2021/ class=next rel=next title="Advent of Code 2021">Advent of Code 2021<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.113.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Mackenzie Morgan</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:15},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script><meta name=plausible content="true"><script type=text/javascript src=https://plausible.io/js/plausible.js async defer data-domain=mackenzie.morgan.name></script></body></html>